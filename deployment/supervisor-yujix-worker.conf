# Supervisor configuration for Yujix Laravel Queue Workers
# Location: /etc/supervisor/conf.d/yujix-worker.conf
#
# After creating this file, run:
# sudo supervisorctl reread
# sudo supervisorctl update
# sudo supervisorctl start yujix-worker:*

[program:yujix-worker]
process_name=%(program_name)s_%(process_num)02d

# IMPORTANT: Point to current symlink for atomic deployments
command=php /var/www/yujix/current/artisan queue:work database --sleep=3 --tries=3 --max-time=3600 --timeout=300

autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=deploy
numprocs=2
redirect_stderr=true

# IMPORTANT: Log to shared storage (persists across deployments)
stdout_logfile=/var/www/yujix/shared/storage/logs/worker.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=3

# Graceful shutdown settings
stopsignal=TERM          # Laravel queue workers handle SIGTERM gracefully
stopwaitsecs=3600        # Wait up to 1 hour for long-running jobs to complete
startretries=3

[group:yujix]
programs=yujix-worker
priority=999
