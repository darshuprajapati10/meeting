; PHP Security Hardening Configuration
; Deploy to: /etc/php/8.2/fpm/conf.d/99-security.ini
;
; This file contains security-focused PHP configuration overrides
; for production environments.
;
; Deployment:
; sudo cp deployment/php-security.ini /etc/php/8.2/fpm/conf.d/99-security.ini
; sudo systemctl reload php8.2-fpm

; ============================================================================
; Security Settings
; ============================================================================

; Hide PHP version in HTTP headers (prevents version-specific attacks)
expose_php = Off

; Disable dangerous functions that allow arbitrary code execution
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source,phpinfo,pcntl_exec,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_getpriority,pcntl_setpriority

; Restrict PHP to only access files in these directories
; Prevents directory traversal attacks
open_basedir = /var/www/yujix:/tmp:/usr/share/php:/dev/urandom

; ============================================================================
; Error Handling (Production)
; ============================================================================

; Never display errors to users (security risk - reveals code structure)
display_errors = Off
display_startup_errors = Off

; Log errors instead of displaying them
log_errors = On
error_log = /var/log/php8.2-fpm-errors.log

; Report all errors internally (for logging)
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT

; Don't log repeated errors
ignore_repeated_errors = On

; ============================================================================
; Resource Limits
; ============================================================================

; Maximum execution time per request (60 seconds)
max_execution_time = 60

; Maximum time to parse input data (60 seconds)
max_input_time = 60

; Maximum memory per script (256MB - adjust based on needs)
memory_limit = 256M

; Maximum POST data size (100MB - for file uploads)
post_max_size = 100M

; Maximum upload file size (100MB)
upload_max_filesize = 100M

; Maximum number of files per upload
max_file_uploads = 20

; ============================================================================
; File Upload Security
; ============================================================================

; Enable file uploads (needed for Laravel)
file_uploads = On

; Temporary upload directory (isolated)
upload_tmp_dir = /tmp/php-uploads

; ============================================================================
; Session Security
; ============================================================================

; Use cookies only for sessions (no URL session IDs)
session.use_only_cookies = 1

; Don't include session ID in URLs (prevents session fixation)
session.use_trans_sid = 0

; Use strict session ID mode (reject invalid session IDs)
session.use_strict_mode = 1

; Mark session cookies as HTTP only (prevents XSS theft)
session.cookie_httponly = 1

; Mark session cookies as secure (HTTPS only)
session.cookie_secure = 1

; Set SameSite attribute (prevents CSRF)
session.cookie_samesite = Strict

; Session lifetime (2 hours)
session.gc_maxlifetime = 7200

; ============================================================================
; Additional Security Headers
; ============================================================================

; Prevent clients from using MIME-sniffing
; Note: Application should also send this header
; X-Content-Type-Options: nosniff

; ============================================================================
; Disabled Features
; ============================================================================

; Disable URL file opening (prevents remote file inclusion)
allow_url_fopen = On  ; Required by Laravel/Composer
allow_url_include = Off  ; Dangerous, keep disabled

; Disable mail header injection
mail.add_x_header = Off

; ============================================================================
; OPcache Settings (Performance + Security)
; ============================================================================

; Enable OPcache
opcache.enable = 1

; Validate timestamps (set to 0 in production for performance)
opcache.validate_timestamps = 1

; Check file timestamps every 60 seconds
opcache.revalidate_freq = 60

; Memory allocated to OPcache (128MB)
opcache.memory_consumption = 128

; Maximum number of cached files
opcache.max_accelerated_files = 10000

; Save comments (required for Laravel annotations)
opcache.save_comments = 1

; ============================================================================
; Realpath Cache (Performance)
; ============================================================================

; Realpath cache size (4MB)
realpath_cache_size = 4096K

; Realpath cache TTL (2 minutes)
realpath_cache_ttl = 120
